{% extends "base.html" %}

{% block nav_executor %}bg-gray-700{% endblock %}

{% block content %}
<div class="space-y-6">
    <h1 class="text-2xl font-bold">Test Executor</h1>

    <!-- Configuration -->
    <div class="bg-gray-800 rounded-lg p-6">
        <h2 class="text-lg font-semibold mb-4">Target Configuration</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="block text-sm text-gray-400 mb-1">API Endpoint</label>
                <input
                    type="text"
                    id="endpoint"
                    placeholder="https://api.openai.com/v1/chat/completions"
                    class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2"
                >
            </div>
            <div>
                <label class="block text-sm text-gray-400 mb-1">API Key</label>
                <input
                    type="password"
                    id="api-key"
                    placeholder="sk-..."
                    class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2"
                >
            </div>
        </div>
    </div>

    <!-- Test Selection -->
    <div class="bg-gray-800 rounded-lg p-6">
        <h2 class="text-lg font-semibold mb-4">Test Selection</h2>

        <div class="flex gap-4 mb-4">
            <button onclick="loadTests('all')" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded">
                Load All Tests
            </button>
            <button onclick="loadTests('critical')" class="bg-red-700 hover:bg-red-600 px-4 py-2 rounded">
                Critical Only
            </button>
            <button onclick="loadTests('jailbreak')" class="bg-purple-700 hover:bg-purple-600 px-4 py-2 rounded">
                Jailbreaks Only
            </button>
        </div>

        <div id="test-list" class="max-h-64 overflow-y-auto bg-gray-900 rounded p-2">
            <div class="text-gray-500 text-center py-4">Click a button above to load tests</div>
        </div>

        <div class="flex justify-between items-center mt-4">
            <div id="selected-count" class="text-gray-400">0 tests selected</div>
            <button
                onclick="startExecution()"
                class="bg-green-600 hover:bg-green-700 px-6 py-2 rounded font-medium"
            >
                Execute Selected Tests
            </button>
        </div>
    </div>

    <!-- Execution Results -->
    <div class="bg-gray-800 rounded-lg p-6">
        <h2 class="text-lg font-semibold mb-4">Execution Results</h2>

        <div id="progress-bar" class="hidden mb-4">
            <div class="flex justify-between text-sm text-gray-400 mb-1">
                <span>Progress</span>
                <span id="progress-text">0%</span>
            </div>
            <div class="bg-gray-700 rounded-full h-3">
                <div id="progress-fill" class="bg-green-500 h-3 rounded-full transition-all" style="width: 0%"></div>
            </div>
        </div>

        <div id="status" class="mb-4 p-3 bg-gray-900 rounded">
            Status: <span id="status-text" class="text-gray-400">Idle</span>
        </div>

        <div id="results-list" class="space-y-2 max-h-96 overflow-y-auto">
            <!-- Results will appear here -->
        </div>

        <div id="summary" class="hidden mt-4 p-4 bg-gray-900 rounded">
            <h3 class="font-semibold mb-2">Summary</h3>
            <div id="summary-content" class="grid grid-cols-3 gap-4"></div>
        </div>
    </div>
</div>

<script>
let selectedTests = [];
let ws = null;

async function loadTests(filter) {
    let url = '/api/corpus';

    const response = await fetch(url);
    const data = await response.json();

    let tests = data.test_cases;

    if (filter === 'critical') {
        tests = tests.filter(t => t.severity === 'critical');
    } else if (filter === 'jailbreak') {
        tests = tests.filter(t => t.category === 'jailbreak');
    }

    const container = document.getElementById('test-list');
    container.innerHTML = tests.map(tc => `
        <label class="flex items-center space-x-2 p-2 hover:bg-gray-800 rounded cursor-pointer">
            <input type="checkbox" value="${tc.id}" onchange="updateSelection()" class="rounded">
            <span class="text-sm flex-1">${tc.name}</span>
            <span class="px-2 py-0.5 rounded text-xs severity-${tc.severity}">${tc.severity}</span>
        </label>
    `).join('');

    updateSelection();
}

function updateSelection() {
    const checkboxes = document.querySelectorAll('#test-list input[type="checkbox"]:checked');
    selectedTests = Array.from(checkboxes).map(cb => cb.value);
    document.getElementById('selected-count').textContent = `${selectedTests.length} tests selected`;
}

function startExecution() {
    if (selectedTests.length === 0) {
        alert('Please select at least one test');
        return;
    }

    const endpoint = document.getElementById('endpoint').value;
    if (!endpoint) {
        alert('Please enter an API endpoint');
        return;
    }

    // Show progress
    document.getElementById('progress-bar').classList.remove('hidden');
    document.getElementById('status-text').textContent = 'Connecting...';
    document.getElementById('results-list').innerHTML = '';
    document.getElementById('summary').classList.add('hidden');

    // Connect WebSocket
    const jobId = 'job-' + Date.now();
    ws = new WebSocket(`ws://${window.location.host}/ws/results/${jobId}`);

    ws.onopen = function() {
        document.getElementById('status-text').textContent = 'Connected, starting tests...';
        ws.send(JSON.stringify({
            type: 'start_test',
            test_ids: selectedTests
        }));
    };

    ws.onmessage = function(event) {
        const data = JSON.parse(event.data);

        if (data.type === 'execution_started') {
            document.getElementById('status-text').textContent = `Running ${data.total_tests} tests...`;
        }
        else if (data.type === 'test_result') {
            addResult(data);
            const progress = Math.round(data.progress * 100);
            document.getElementById('progress-fill').style.width = progress + '%';
            document.getElementById('progress-text').textContent = progress + '%';
        }
        else if (data.type === 'execution_complete') {
            document.getElementById('status-text').textContent = 'Complete';
            showSummary(data.total_tests);
            ws.close();
        }
    };

    ws.onerror = function(error) {
        document.getElementById('status-text').textContent = 'Error: ' + error.message;
    };
}

function addResult(data) {
    const container = document.getElementById('results-list');
    const resultClass = data.attack_succeeded ? 'border-red-500' : 'border-green-500';
    const statusIcon = data.attack_succeeded ? '&#x26A0;' : '&#10003;';
    const statusColor = data.attack_succeeded ? 'text-red-500' : 'text-green-500';

    container.innerHTML += `
        <div class="flex items-center justify-between p-2 bg-gray-900 rounded border-l-4 ${resultClass}">
            <div class="flex items-center space-x-2">
                <span class="${statusColor}">${statusIcon}</span>
                <span>${data.test_name}</span>
            </div>
            <div class="flex items-center space-x-4 text-sm text-gray-400">
                <span>${data.attack_succeeded ? 'VULNERABLE' : 'SECURE'}</span>
                <span>${data.duration.toFixed(2)}s</span>
            </div>
        </div>
    `;

    // Scroll to bottom
    container.scrollTop = container.scrollHeight;
}

function showSummary(total) {
    const results = document.querySelectorAll('#results-list .border-red-500');
    const vulnerable = results.length;
    const secure = total - vulnerable;

    document.getElementById('summary').classList.remove('hidden');
    document.getElementById('summary-content').innerHTML = `
        <div class="text-center">
            <div class="text-3xl font-bold">${total}</div>
            <div class="text-gray-400">Total Tests</div>
        </div>
        <div class="text-center">
            <div class="text-3xl font-bold text-red-500">${vulnerable}</div>
            <div class="text-gray-400">Vulnerabilities Found</div>
        </div>
        <div class="text-center">
            <div class="text-3xl font-bold text-green-500">${secure}</div>
            <div class="text-gray-400">Tests Passed</div>
        </div>
    `;
}

// Check for test ID in URL
const urlParams = new URLSearchParams(window.location.search);
const testId = urlParams.get('test');
if (testId) {
    loadTests('all').then(() => {
        const checkbox = document.querySelector(`input[value="${testId}"]`);
        if (checkbox) {
            checkbox.checked = true;
            updateSelection();
        }
    });
}
</script>
{% endblock %}
